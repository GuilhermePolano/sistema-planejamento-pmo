flowchart TD
    UPLOAD_START([Upload Iniciado]) --> VALIDATE_FILE{Arquivo Válido?}
    VALIDATE_FILE -->|Não| REJECT_FILE[Rejeitar Arquivo]
    VALIDATE_FILE -->|Sim| SAVE_TEMP[Salvar Temporariamente]
    SAVE_TEMP --> CREATE_PROCESSOR[Criar ExcelProcessor]
    CREATE_PROCESSOR --> PROCESS_FILE[Processar Arquivo]
    PROCESS_FILE --> PARSE_CONTENT[Parsear Conteúdo]
    PARSE_CONTENT --> LOAD_STACKS[Carregar Stacks]
    LOAD_STACKS --> PROCESS_LINES[Processar Linhas]
    PROCESS_LINES --> CREATE_ENTITIES[Criar Entidades]
    CREATE_ENTITIES --> VALIDATE_ENTITIES{Dados Válidos?}
    VALIDATE_ENTITIES -->|Não| CLEANUP_ERROR[Limpar e Erro]
    VALIDATE_ENTITIES -->|Sim| SAVE_ENTITIES[Salvar Entidades]
    SAVE_ENTITIES --> SAVE_MONGO{MongoDB Disponível?}
    SAVE_MONGO -->|Sim| SAVE_TO_MONGO[Salvar no MongoDB]
    SAVE_MONGO -->|Não| SAVE_TO_JSON[Salvar em JSON]
    SAVE_TO_MONGO --> CLEANUP_SUCCESS[Limpar Arquivo]
    SAVE_TO_JSON --> CLEANUP_SUCCESS
    CLEANUP_SUCCESS --> SUCCESS_RESPONSE[Resposta de Sucesso]
    
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    
    class UPLOAD_START,SUCCESS_RESPONSE startEnd
    class SAVE_TEMP,CREATE_PROCESSOR,PROCESS_FILE,PARSE_CONTENT,LOAD_STACKS,PROCESS_LINES,CREATE_ENTITIES,SAVE_ENTITIES,SAVE_TO_MONGO,SAVE_TO_JSON,CLEANUP_SUCCESS process
    class VALIDATE_FILE,VALIDATE_ENTITIES,SAVE_MONGO decision
    class REJECT_FILE,CLEANUP_ERROR error
