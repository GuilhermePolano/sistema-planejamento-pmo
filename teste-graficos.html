<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Gr√°ficos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background: #007bff;
            color: white;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Gr√°ficos</h1>
        
        <div class="test-section">
            <h3>1. Testar Dados da API</h3>
            <button class="btn" onclick="testarDados()">Carregar Dados</button>
            <div id="result-dados"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Gr√°fico de Status (Doughnut)</h3>
            <div class="chart-container">
                <canvas id="grafico-status-test"></canvas>
            </div>
            <button class="btn" onclick="criarGraficoStatus()">Criar Gr√°fico Status</button>
        </div>
        
        <div class="test-section">
            <h3>3. Gr√°fico de Velocidade (Bar)</h3>
            <div class="chart-container">
                <canvas id="grafico-velocidade-test"></canvas>
            </div>
            <button class="btn" onclick="criarGraficoVelocidade()">Criar Gr√°fico Velocidade</button>
        </div>
        
        <div class="test-section">
            <h3>4. Log de Erros</h3>
            <div id="log-erros"></div>
        </div>
    </div>

    <script>
        let dadosIndicadores = null;
        let charts = {};

        async function testarDados() {
            const resultDiv = document.getElementById('result-dados');
            resultDiv.innerHTML = 'Carregando dados...';
            
            try {
                const response = await fetch('/api/indicadores-projetos');
                const data = await response.json();
                
                if (data.success) {
                    dadosIndicadores = data.data;
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Dados carregados com sucesso!<br>
                            Total de projetos: ${dadosIndicadores.totalProjetos}<br>
                            Projetos no prazo: ${dadosIndicadores.projetosNoPrazo}<br>
                            Projetos em aten√ß√£o: ${dadosIndicadores.projetosAtencao}<br>
                            Projetos atrasados: ${dadosIndicadores.projetosAtrasados}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
                logErro('Erro ao carregar dados: ' + error.message);
            }
        }

        function criarGraficoStatus() {
            if (!dadosIndicadores) {
                alert('Carregue os dados primeiro!');
                return;
            }

            try {
                const ctx = document.getElementById('grafico-status-test').getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (charts.status) {
                    charts.status.destroy();
                }
                
                const dados = {
                    noPrazo: dadosIndicadores.projetosNoPrazo || 0,
                    atencao: dadosIndicadores.projetosAtencao || 0,
                    atrasado: dadosIndicadores.projetosAtrasados || 0
                };
                
                console.log('Dados para gr√°fico de status:', dados);
                
                charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['No Prazo', 'Aten√ß√£o', 'Atrasado'],
                        datasets: [{
                            data: [dados.noPrazo, dados.atencao, dados.atrasado],
                            backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                logSucesso('Gr√°fico de status criado com sucesso!');
            } catch (error) {
                logErro('Erro ao criar gr√°fico de status: ' + error.message);
            }
        }

        function criarGraficoVelocidade() {
            if (!dadosIndicadores) {
                alert('Carregue os dados primeiro!');
                return;
            }

            try {
                const ctx = document.getElementById('grafico-velocidade-test').getContext('2d');
                
                // Destruir gr√°fico anterior se existir
                if (charts.velocidade) {
                    charts.velocidade.destroy();
                }
                
                const projetos = dadosIndicadores.projetos || [];
                console.log('Projetos para gr√°fico de velocidade:', projetos.length);
                
                const topProjetos = projetos
                    .filter(p => p.velocidade && p.velocidade > 0)
                    .sort((a, b) => (b.velocidade || 0) - (a.velocidade || 0))
                    .slice(0, 5);
                
                console.log('Top projetos para velocidade:', topProjetos);
                
                if (topProjetos.length === 0) {
                    logErro('Nenhum projeto com velocidade v√°lida encontrado');
                    return;
                }
                
                charts.velocidade = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topProjetos.map(p => p.nome ? p.nome.substring(0, 15) + '...' : 'Projeto sem nome'),
                        datasets: [{
                            label: 'Velocidade (tarefas/dia)',
                            data: topProjetos.map(p => p.velocidade || 0),
                            backgroundColor: '#667eea',
                            borderColor: '#5a6fd8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                logSucesso('Gr√°fico de velocidade criado com sucesso!');
            } catch (error) {
                logErro('Erro ao criar gr√°fico de velocidade: ' + error.message);
            }
        }

        function logErro(mensagem) {
            const logDiv = document.getElementById('log-erros');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="error">[${timestamp}] ‚ùå ${mensagem}</div>`;
            console.error(mensagem);
        }

        function logSucesso(mensagem) {
            const logDiv = document.getElementById('log-erros');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="success">[${timestamp}] ‚úÖ ${mensagem}</div>`;
            console.log(mensagem);
        }

        // Capturar erros globais
        window.addEventListener('error', function(e) {
            logErro('Erro global: ' + e.message + ' em ' + e.filename + ':' + e.lineno);
        });

        window.addEventListener('unhandledrejection', function(e) {
            logErro('Promise rejeitada: ' + e.reason);
        });
    </script>
</body>
</html>
